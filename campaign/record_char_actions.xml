<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the LICENSE.md file included with this distribution for attribution and copyright information. -->

<root>
	<windowclass name="char_weapon" merge="join">
		<sheetdata>
			<stringu name="name">
				<anchored height="20">
					<top offset="5" />
					<left parent="leftanchor" anchor="right" relation="relative" offset="2" />
					<right parent="rightanchor" anchor="left" relation="relative" offset="0" />
				</anchored>
				<script>
					function onValueChanged()
						window.isloaded.onDataChanged();
					end
				</script>
				<delaykeyupdate />
			</stringu>
			
			<number_charweaponfullattack name="attacks">
				<anchored to="attackicons" position="over" />
				<script>
					function automateAmmo()
						local nodeAttack = getDatabaseNode().getParent();
						
						local bNotLoaded = (DB.getValue(nodeAttack, 'isloaded') == 0);
						if window.isloaded.hasLoadAction() and bNotLoaded then
							local rActor = ActorManager.getActor("", nodeAttack.getChild('...'));
							local sWeaponName = DB.getValue(nodeAttack, 'name', 'ranged weapon');
							
							ChatManager.Message(string.format(Interface.getString('char_actions_notloaded'), sWeaponName), nil, rActor);
						end
						
						DB.setValue(nodeAttack, 'isloaded', 'number', 0);
					end
					function onDoubleClick(x,y)
						automateAmmo()
						return action();
					end
				</script>
			</number_charweaponfullattack>		
			<number_charweaponattacktotal name="attack1">
				<anchored to="attackframe" position="insidetopleft" offset="3,0" width="27" height="20" />
				<modifier>0</modifier>
				<name>Attack 1</name>
				<source><name>attack1modifier</name><op>+</op></source>
				<script>
					function onDoubleClick(x,y)
						window.attacks.automateAmmo()
						
						return action();
					end
				</script>
			</number_charweaponattacktotal>
			<number_charweaponattacktotal name="attack2">
				<anchored to="attack1" position="right" offset="5,0" width="27" />
				<modifier>-5</modifier>
				<name>Attack 2</name>
				<source><name>attack2modifier</name><op>+</op></source>
				<script>
					function onDoubleClick(x,y)
						window.attacks.automateAmmo()
						
						return action();
					end
				</script>
			</number_charweaponattacktotal>
			<number_charweaponattacktotal name="attack3">
				<anchored to="attack2" position="right" offset="5,0" width="27" />
				<modifier>-10</modifier>
				<name>Attack 3</name>
				<source><name>attack3modifier</name><op>+</op></source>
				<script>
					function onDoubleClick(x,y)
						window.attacks.automateAmmo()
						
						return action();
					end
				</script>
			</number_charweaponattacktotal>
			<number_charweaponattacktotal name="attack4">
				<anchored to="attack3" position="right" offset="5,0" width="27" />
				<modifier>-15</modifier>
				<name>Attack 4</name>
				<source><name>attack4modifier</name><op>+</op></source>
				<script>
					function onDoubleClick(x,y)
						window.attacks.automateAmmo()
						
						return action();
					end
				</script>
			</number_charweaponattacktotal>
			
			<!-- Ranged specific fields -->
			<buttonfield name="isloaded">
				<anchored width="12" height="12">
					<top parent="label_ammo" anchor="top" relation="relative" offset="4" />
					<right parent="label_ammo" anchor="left" relation="relative" offset="0" />
				</anchored>
				<state icon="button_checkoff" tooltipres="tooltip_actions_unloaded" />
				<state icon="button_checkon" tooltipres="tooltip_actions_loaded" />
				<default>0</default>
				<script>
					function onInit()
						local sNode = getDatabaseNode().getParent().getNodeName();
						DB.addHandler(sNode, "onChildUpdate", onDataChanged);
						onDataChanged();
					end
					function hasLoadAction()
						local bRanged = (window.type.getValue() == 1);
						local sWeaponName = string.lower(DB.getValue(getDatabaseNode().getParent(), 'name', 'ranged weapon'));
						local bHasLoadAction = false
						local tLoadWeapons = { 'firearm', 'crossbow', 'javelin', 'ballista', 'windlass', 'pistol', 'rifle', 'sling', 'loadaction' }
						for _,v in pairs(tLoadWeapons) do
							if string.find(sWeaponName, v) then bHasLoadAction = true; break; end
						end
						
						if bRanged and bHasLoadAction then return true; end
					end
					function onDataChanged()
						if hasLoadAction() then setVisible(true); else setVisible(false); end
					end
					function onButtonPress()
						local rActor = ActorManager.getActor("", getDatabaseNode().getChild('....'));
						local sWeaponName = DB.getValue(getDatabaseNode().getParent(), 'name', 'ranged weapon');

						if (getValue() == 1) then ChatManager.Message(string.format(Interface.getString('char_actions_load'), string.lower(sWeaponName)), nil, rActor); end
					end
				</script>
			</buttonfield>
		</sheetdata>
	</windowclass>
</root>
