<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the LICENSE.md file included with this distribution for attribution and copyright information. -->

<root>
	<windowclass name="charmini_weapon" merge="join">
		<script>
			function onInit()
				if super and super.onInit then
					super.onInit();
				end
				DB.addHandler(getDatabaseNode().getChild('name').getNodeName(), "onUpdate", toggleDetail);
				toggleDetail();
			end
			function onClose()
				if super and super.onClose then
					super.onClose();
				end
				DB.removeHandler(getDatabaseNode().getChild('name').getNodeName(), "onUpdate", toggleDetail);
			end
			function onTypeChanged()
				if super and super.onTypeChanged then
					super.onTypeChanged();
				end
				toggleDetail();
			end
			function hasLoadAction(bRanged)
				local bHasLoadAction
				local sWeaponName = string.lower(DB.getValue(getDatabaseNode(), 'name', 'ranged weapon'));
				for _,v in pairs(AmmunitionManager.tLoadWeapons) do
					if string.find(sWeaponName, v) then bHasLoadAction = true; break; end
				end

				return (bRanged and bHasLoadAction)
			end
			function toggleDetail()
				if super and super.toggleDetail then
					super.toggleDetail();
				end
				local bRanged = (type.getValue() == 1);
				
				isloaded.setVisible(hasLoadAction(bRanged));
				if button_reload then button_reload.setVisible(bRanged) end
				maxammo.setVisible(bRanged);
				ammo_label.setVisible(bRanged);
				ammocounter.setVisible(bRanged);
			end
		</script>
		<sheetdata>
			<genericcontrol name="attackicon">
				<script>
					function onHover(bOnControl)
						window.highlightAttack(bOnControl);
					end
					local function automateAmmo(nodeWeapon)
						local bNotLoaded = (DB.getValue(nodeWeapon, 'isloaded') == 0);
						DB.setValue(nodeWeapon, 'isloaded', 'number', 0);
						local bRanged = (window.type.getValue() == 1);
						if window.hasLoadAction(bRanged) and bNotLoaded then
							local rActor = ActorManager.resolveActor(nodeWeapon.getChild('...'));
							local sWeaponName = string.lower(DB.getValue(nodeWeapon, 'name', 'ranged weapon'));
							
							ChatManager.Message(string.format(Interface.getString('char_actions_notloaded'), sWeaponName), true, rActor);
							return true;
						end
					end
					function onDoubleClick(x,y)
						local rActor, _, _ = CharManager.getAdvancedRollStructures("attack", nil, window.getDatabaseNode());
						local nodeWeapon = window.getDatabaseNode();

						local nAmmo, bInfiniteAmmo = AmmunitionManager.getAmmoRemaining(rActor, nodeWeapon, AmmunitionManager.getAmmoNode(nodeWeapon, rActor))

						if (bInfiniteAmmo or nAmmo &gt; 0) then	
							if not automateAmmo(nodeWeapon) then return window.onAttackAction(); end
						else
							ChatManager.Message(Interface.getString('char_actions_noammo'), true, rActor);
						end			
					end			
					function onDragStart(button, x, y, draginfo)
						local rActor, _, _ = CharManager.getAdvancedRollStructures("attack", nil, window.getDatabaseNode());
						local nodeWeapon = window.getDatabaseNode();

						local nAmmo, bInfiniteAmmo = AmmunitionManager.getAmmoRemaining(rActor, nodeWeapon, AmmunitionManager.getAmmoNode(nodeWeapon, rActor))

						if (bInfiniteAmmo or nAmmo &gt; 0) then	
							if not automateAmmo(nodeWeapon) then return window.onAttackAction(draginfo); end
						else
							ChatManager.Message(Interface.getString('char_actions_noammo'), true, rActor);
						end			
					end
				</script>
			</genericcontrol>

			<label name="range_label">
				<anchored>
					<left offset="30" />
				</anchored>
			</label>
			<!-- <buttonfield name="button_reload">
				<anchored width="27" height="10">
					<top parent="name" anchor="bottom" offset="6" />
					<left offset="-2" />
				</anchored>
				<icon normal="button_reload" pressed="button_reload_down" />
				<tooltip textres="weapon_tooltip_reloadammo" />
				<default>0</default>
				<maxammo>maxammo</maxammo>
				<ammo>ammo</ammo>
				<count>count</count>
				<script file="campaign/scripts/ammo_reloadammo.lua" />
			</buttonfield> -->
			<buttonfield name="isloaded">
				<!-- <anchored width="27" height="10">
					<top parent="button_reload" anchor="bottom" offset="1" />
					<left offset="-2" />
				</anchored> -->
				<anchored width="27" height="10">
					<top parent="name" anchor="bottom" offset="11" />
					<left offset="-2" />
				</anchored>
				<state icon="button_load" tooltipres="tooltip_actions_unloaded" />
				<state icon="button_unload" tooltipres="tooltip_actions_loaded" />
				<default>0</default>
				<script file="campaign/scripts/ammo_isloaded.lua" />
			</buttonfield>
		</sheetdata>
	</windowclass>
</root>
