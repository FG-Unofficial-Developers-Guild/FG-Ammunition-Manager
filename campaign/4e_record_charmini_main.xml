<?xml version="1.0" encoding="iso-8859-1"?>

<!-- Please see the LICENSE.md file included with this distribution for attribution and copyright information. -->

<root>
	<windowclass name="charmini_weapon" merge="join">
		<script>
			function onInit()
				if super and super.onInit then
					super.onInit();
				end
				DB.addHandler(getDatabaseNode().getChild('name').getNodeName(), "onUpdate", toggleDetail);
				toggleDetail();
			end
			function onClose()
				if super and super.onClose then
					super.onClose();
				end
				DB.removeHandler(getDatabaseNode().getChild('name').getNodeName(), "onUpdate", toggleDetail);
			end
			function onTypeChanged()
				if super and super.onTypeChanged then
					super.onTypeChanged();
				end
				toggleDetail();
			end
			function hasLoadAction(bRanged)
				local bHasLoadAction
				local sWeaponName = string.lower(DB.getValue(getDatabaseNode(), 'name', 'ranged weapon'));
				for _,v in pairs(AmmunitionManager.tLoadWeapons) do
					if string.find(sWeaponName, v) then bHasLoadAction = true; break; end
				end

				return (bRanged and bHasLoadAction)
			end
			function toggleDetail()
				if super and super.toggleDetail then
					super.toggleDetail();
				end
				local bRanged = (type.getValue() == 1);
				
				maxammo.setVisible(bRanged);
				ammo_label.setVisible(bRanged);
				ammocounter.setVisible(bRanged);
				
				isloaded.setVisible(hasLoadAction(bRanged));
				switchAmmo(bRanged);
			end
			function switchAmmo(bRanged)
				local bAmmoPickerIsEmpty = (ammopicker.getValue() == "");
				local bMaxAmmoIsZero = (maxammo.getValue() == 0);
				Debug.chat(bRanged, bAmmoPickerIsEmpty, bMaxAmmoIsZero);
				ammopicker.setComboBoxVisible(bRanged and (bMaxAmmoIsZero or not bAmmoPickerIsEmpty));
				maxammo.setVisible(bRanged and (bAmmoPickerIsEmpty or not bMaxAmmoIsZero));
				ammocounter.setVisible(bRanged and (bAmmoPickerIsEmpty or not bMaxAmmoIsZero));
			end
		</script>
		<sheetdata>
			<genericcontrol name="attackicon">
				<script>
					function onHover(bOnControl)
						window.highlightAttack(bOnControl);
					end
					local function automateAmmo(nodeWeapon)
						local bNotLoaded = (DB.getValue(nodeWeapon, 'isloaded') == 0);
						DB.setValue(nodeWeapon, 'isloaded', 'number', 0);
						local bRanged = (window.type.getValue() == 1);
						if window.hasLoadAction(bRanged) and bNotLoaded then
							local rActor = ActorManager.resolveActor(nodeWeapon.getChild('...'));
							local sWeaponName = string.lower(DB.getValue(nodeWeapon, 'name', 'ranged weapon'));
							
							ChatManager.Message(string.format(Interface.getString('char_actions_notloaded'), sWeaponName), true, rActor);
							return true;
						end
					end
					function onDoubleClick(x,y)
						local rActor, _, _ = CharManager.getAdvancedRollStructures("attack", nil, window.getDatabaseNode());

						local nodeWeapon = window.getDatabaseNode();
						local nMaxAmmo = DB.getValue(nodeWeapon, 'maxammo', 0)
						local nMaxAttacks = nMaxAmmo - DB.getValue(nodeWeapon, 'ammo', 0)
						if not (nMaxAmmo > 0) or (1 &lt;= nMaxAttacks) then	
							if not automateAmmo(nodeWeapon) then return window.onAttackAction(); end
						elseif nMaxAmmo > 0 then
							ChatManager.Message(Interface.getString('char_actions_noammo'), true, rActor);
						end			
					end			

					function onDragStart(button, x, y, draginfo)
						local rActor, _, _ = CharManager.getAdvancedRollStructures("attack", nil, window.getDatabaseNode());

						local nodeWeapon = window.getDatabaseNode();
						local nMaxAmmo = DB.getValue(nodeWeapon, 'maxammo', 0)
						local nMaxAttacks = nMaxAmmo - DB.getValue(nodeWeapon, 'ammo', 0)
						if not (nMaxAmmo > 0) or (1 &lt;= nMaxAttacks) then	
							if not automateAmmo(nodeWeapon) then return window.onAttackAction(draginfo); end
						elseif nMaxAmmo > 0 then
							ChatManager.Message(Interface.getString('char_actions_noammo'), true, rActor);
						end			
					end
				</script>
			</genericcontrol>

			<buttonfield name="isloaded">
				<anchored width="12" height="12">
					<top parent="ammo_label" anchor="top" relation="relative" offset="4" />
					<right parent="ammo_label" anchor="left" relation="relative" offset="0" />
				</anchored>
				<state icon="button_checkoff" tooltipres="tooltip_actions_unloaded" />
				<state icon="button_checkon" tooltipres="tooltip_actions_loaded" />
				<default>0</default>
				<script>
					function onInit()
						local sNode = getDatabaseNode().getParent().getNodeName();
						DB.addHandler(sNode, "onChildUpdate", onDataChanged);
						onDataChanged();
					end
					function onClose()
						local sNode = getDatabaseNode().getParent().getNodeName();
						DB.removeHandler(sNode, "onChildUpdate", onDataChanged);
						onDataChanged();
					end
					function onDataChanged()
						local bRanged = (window.type.getValue() == 1);
						setVisible(window.hasLoadAction(bRanged))
					end
					function onButtonPress()
						local nodeActor = getDatabaseNode().getChild('....');
						local rActor = ActorManager.resolveActor(nodeActor);
						local sActorName = DB.getValue(nodeActor, 'name', 'Someone');

						local nodeWeapon = window.getDatabaseNode();
						local sWeaponName = string.lower(DB.getValue(nodeWeapon, 'name', 'ranged weapon'));
						local nMaxAmmo = DB.getValue(nodeWeapon, 'maxammo', 0)
						local nMaxAttacks = nMaxAmmo - DB.getValue(nodeWeapon, 'ammo', 0)
						if (getValue() == 1) and nMaxAttacks >= 1 then
							ChatManager.Message(string.format(Interface.getString('char_actions_load'), sWeaponName), true, rActor);
						end
					end
				</script>
			</buttonfield>
			<basicnumber name="maxammo">
				<script>
					function onValueChanged()
						if super and super.onValueChanged then
							super.onValueChanged();
						end
						window.switchAmmo(window.type.getValue() == 1)
					end
				</script>
			</basicnumber>
			<combobox name="ammopicker">
				<frame>
					<hidereadonly />
				</frame>
				<center />
				<listdirection>down</listdirection>
				<listmaxsize>15</listmaxsize>
				<nodrag />
				<nodrop />
				<noreset />
				<anchored width="80" height="20">
					<top parent="maxammo" anchor="top" />
					<right parent="damageview" anchor="right" offset="0" />
				</anchored>
				<default textres="none" />
				<script>
					function onInit()
						if super and super.onInit then
							super.onInit();
						end

						local aAutoFill = {};
						table.insert(aAutoFill, Interface.getString("none"));
						for _,v in pairs(window.getDatabaseNode().getChild('...inventorylist').getChildren()) do
							local sName = DB.getValue(v, "name", "");
							local sClass = DB.getValue(v, "class", ""):lower()
							local bAmmo = sClass:match("ammunition") or sClass:match("ammo");
							if bAmmo then
								if sName ~= "" then
									table.insert(aAutoFill, sName);
								end
							end
						end
						addItems(aAutoFill)
					end
					function onValueChanged()
						if super and super.onValueChanged then
							super.onValueChanged();
						end
						window.switchAmmo(window.type.getValue() == 1)
					end
				</script>
			</combobox>
		</sheetdata>
	</windowclass>
</root>
